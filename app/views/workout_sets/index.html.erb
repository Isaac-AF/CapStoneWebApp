<div class="container" style="max-width: 700px;">

  <% if @list_of_workout_sets.empty? %>
    <form action="/delete_if_empty_and_back" method="post" class="text-center my-4">
      <input type="hidden" name="workout_id" value="<%= params.fetch("workout_id") %>">
      <input type="submit" value="Go Back" class="btn btn-outline-secondary">
    </form>
  <% else %>

  <% end %>

  <div class="d-flex justify-content-center gap-2 mb-4">
    <form action="/finish_workout" method="post">
      <input type="hidden" name="query_workout_id" value="<%= params.fetch("workout_id") %>">
      <input type="submit" value="Finish Workout" class="btn btn-success" />
    </form>

    <form action="/exercises" method="get">
      <input type="hidden" name="return_to" value="<%= request.fullpath %>">
      <input type="submit" value="Manage Exercises" class="btn btn-outline-primary" />
    </form>
  </div>

  <div class="card mb-5">
    <div class="card-body">
      <h2 class="card-title text-center mb-4">Add a New Workout Set</h2>
      <form action="/insert_workout_set" method="post">
        <input type="hidden" name="query_workout_id" value="<%= params.fetch("workout_id") %>">

        <div class="mb-3">
          <label for="exercise_id_box" class="form-label">Exercise</label>
            <select class="form-select" id="exercise_id_box" name="query_exercise_id">
              <% Exercise.order(:exercise_name).each do |exercise| %>
                <option value="<%= exercise.id %>" <%= 'selected="selected"' if exercise.id == @last_exercise_id %>>
                  <%= exercise.exercise_name %>
                </option>
              <% end %>
            </select>
        </div>

        <div class="mb-3">
          <label for="workout_set_number" class="form-label">Set Number</label>
          <input type="text" class="form-control" id="workout_set_number" name="query_workout_set_number" value="1">
        </div>

        <div class="mb-3">
          <label for="workout_reps_count_box" class="form-label">Reps</label>
          <input type="text" class="form-control" id="workout_reps_count_box" name="query_workout_reps_count" value="">
        </div>

        <div class="mb-4">
          <label for="weight_box" class="form-label">Weight</label>
          <input type="text" class="form-control" id="weight_box" name="query_weight" value="">
        </div>

        <div id="recent-sets-wrapper" class="mb-4 d-none">
          <label class="form-label">Last Time You Did This Exercise:</label>
          <div class="border rounded p-3">
            <div class="small text-muted mb-2">
              Date: <span id="recent-date"></span>
            </div>
            <ul id="recent-sets-list" class="list-group list-group-flush"></ul>
          </div>
        </div>

        <div class="text-center">
          <button type="submit" class="btn btn-primary">Create Workout Set</button>
        </div>
      </form>
    </div>
  </div>

  <h2 class="text-center mb-3">Workout Sets</h2>

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Exercise</th>
          <th>Set Number</th>
          <th>Reps</th>
          <th>Weight</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @list_of_workout_sets.each do |a_workout_set| %>
          <tr>
            <td><%= a_workout_set.exercise.exercise_name %></td>
            <td><%= a_workout_set.set_number %></td>
            <td><%= a_workout_set.workout_reps_count %></td>
            <td><%= a_workout_set.weight %></td>
            <td>
              <a href="/workout_sets/<%= params.fetch("workout_id") %>/<%= a_workout_set.id %>" class="btn btn-sm btn-outline-secondary">
                Show Details
              </a>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

</div>


<!-- JavaScript to dynamically update set number and weight-->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const exerciseSelect = document.getElementById("exercise_id_box");
    const setNumberInput = document.getElementById("workout_set_number");
    const repsInput = document.getElementById("workout_reps_count_box");
    const weightInput = document.getElementById("weight_box");

    const recentWrap = document.getElementById("recent-sets-wrapper");
    const recentDateEl = document.getElementById("recent-date");
    const recentListEl = document.getElementById("recent-sets-list");

    const workoutId = "<%= params.fetch("workout_id") %>";
    const userId = "<%= @workout.user_id %>";

    // Holds the most-recent-day's sets for the currently selected exercise
    // keyed by set_number: { "1": {reps, weight}, ... }
    let recentBySetNumber = {};

    function refreshNextSetNumber(exerciseId) {
      return fetch(`/next_set_number?workout_id=${workoutId}&exercise_id=${exerciseId}`)
        .then(response => response.json())
        .then(data => {
          setNumberInput.value = data.next_set_number;
        });
    }

    function showRecentBox(innerHTML) {
    recentWrap.classList.remove("d-none");
    recentDateEl.textContent = "";
    recentListEl.innerHTML = innerHTML;
    }

    function applyDefaultsFromRecent() {
      const key = String(setNumberInput.value || "");
      const item = recentBySetNumber[key];
      if (item) {
        // Only override if inputs are empty (keeps user edits)
        if (!repsInput.value)   repsInput.value = item.reps;
        if (!weightInput.value) weightInput.value = item.weight;
      }
    }

    function renderRecentSets(data) {
      // Reset UI + map
      recentBySetNumber = {};
      recentListEl.innerHTML = "";

      if (!data || !data.sets || data.sets.length === 0) {
        recentWrap.classList.add("d-none");
        return;
      }

      recentWrap.classList.remove("d-none");
      recentDateEl.textContent = data.date;

      data.sets.forEach(s => {
        recentBySetNumber[String(s.set_number)] = { reps: s.reps, weight: s.weight };

        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <span><strong>Set ${s.set_number}</strong></span>
          <span>${s.reps} reps @ ${s.weight}</span>
        `;
        recentListEl.appendChild(li);
      });

      // Try to fill current inputs based on the (possibly updated) set number
      applyDefaultsFromRecent();
    }

    function refreshRecentSets(exerciseId) {
      if (!userId) {
        recentWrap.classList.add("d-none");
        return Promise.resolve();
      }

      const url = `/recent_sets?user_id=${encodeURIComponent(userId)}&exercise_id=${encodeURIComponent(exerciseId)}&exclude_workout_id=${encodeURIComponent(workoutId)}`;

      return fetch(url, { headers: { "Accept": "application/json" }})
        .then(async r => {
          // Non-2xx â†’ throw with body text for console
          if (!r.ok) {
            const text = await r.text();
            throw new Error(`recent_sets ${r.status}: ${text}`);
          }
          const ct = r.headers.get("content-type") || "";
          if (!ct.includes("application/json")) {
            throw new Error(`recent_sets: unexpected content-type ${ct}`);
          }
          return r.json();
        })
        .then(renderRecentSets)
        .catch(err => {
          console.error(err);
          // Hide the entire box on error
          recentWrap.classList.add("d-none");
        });
    }

    async function onExerciseChange() {
      const exerciseId = exerciseSelect.value;

      // Clear current defaults so the fresh values can populate
      repsInput.value = "";
      weightInput.value = "";

      await refreshNextSetNumber(exerciseId);
      await refreshRecentSets(exerciseId);

      // After both calls, try to apply defaults again (covers when next_set_number changed)
      applyDefaultsFromRecent();
    }

    function onSetNumberChange() {
      // When user changes the set number, update defaults from recent map
      // (does not override if the fields already have values)
      applyDefaultsFromRecent();
    }

    exerciseSelect.addEventListener("change", onExerciseChange);
    setNumberInput.addEventListener("input", onSetNumberChange);

    // Initial load
    exerciseSelect.dispatchEvent(new Event('change'));
  });
</script>
